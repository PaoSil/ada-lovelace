webpackJsonp([308],{1486:function(e,i){(function(){TS.registerModule("highlights_briefing",{sli_recaps_debug_group:null,updated_sig:new signals.Signal,$briefing_header:null,$briefing_view:null,last_request_id:null,last_cached_request_id:void 0,onStart:function e(){if(!TS.client)return;TS.client.ui.unread.started_sig.add(d);TS.client.unread.switched_away_sig.add(b);TS.channels.switched_sig.add(j);TS.groups.switched_sig.add(j);TS.mpims.switched_sig.add(j);TS.ims.switched_sig.add(j);TS.client.threads.switched_sig.add(x);TS.channels.marked_sig.add(W);TS.groups.marked_sig.add(W);TS.channels.message_changed_sig.add(U);TS.groups.message_changed_sig.add(U);TS.channels.message_removed_sig.add(J);TS.groups.message_removed_sig.add(J);TS.pins.pinned_status_changed_sig.add(L);TS.client.highlights.feedback_submitted_sig.add(B);TS.experiment.loadUserAssignments().then(function(){TS.highlights_briefing.sli_recaps_debug_group=TS.experiment.getGroup("sli_recaps_debug")})},showBriefing:function i(){if(!TS.model.team.plan||!e||!n)return;e.removeClass("hidden");n.toggleClass("hidden",!a.expanded)},hideBriefing:function i(){if(!TS.model.team.plan||!e||!n)return;e.addClass("hidden");n.addClass("hidden")},clogBackButton:function e(){var i=_.get(a,["last_jump","model_ob_id"]);var t=_.get(a,["last_jump","ts"]);var n={channel_id:i,channel_type:i[0]||"",message_timestamp:t};var s;var r=TS.client.highlights.getHighlight(i,t);if(r){n.request_id=r.request_id;s=r.cached_request_id}if(s)n.cached_request_id=s;TS.clog.track("BRIEFING_BACK_TO_BRIEFING",n)},jumpToMessageInChannel:function e(i,t){A(i,t)},setUnreadPointOnMessage:function e(i){if(!TS.model.team.plan)return;i=String(i);var t=$('.sli_briefing__message ts-message[data-ts="'+i+'"]');if(t.length){var n=t.data("model-ob-id");TS.shared.markReadMsg(n,i,TS.model.marked_reasons.back);TS.client.markLastReadsWithAPI();W(TS.shared.getModelObById(n))}},getMessageFromCache:function e(i,t){return _.get(s,[i,t],null)},promiseToGetBriefing:function e(){if(""===TS.model.team.plan)return Promise.resolve(null);return TS.api.call("highlights.briefing").catch(function(){return Promise.resolve(null)})},showBriefingWithResponse:function e(i){o(i)}});var e=null;var i=null;var t=null;var n=null;var s={};var a={expanded:false,scroll_top:0,last_jump:{ts:null,model_ob_id:null},show_briefing_back_button:false,last_open_ts:null,loading:true};var r={};var l=3;var d=function e(){if(!TS.model.team.plan)return;if(a.show_briefing_back_button||_.get(a,["last_jump","model_ob_id"]))I();a.briefing_opens_count=TS.storage.fetchBriefingOpensCount();a.loading=true;c()};var o=function e(i){Promise.resolve(i).then(g).then(f).catch(function(e){TS.error("A call to highlights.briefing failed:");TS.logError(e,"Highlights in All Unreads either failed to render or got an error from the API");m(null,0,false,true)});H()};var g=function e(i){var t={};if(_.get(i,"data.messages.length")){i.data.messages=_.map(i.data.messages,function(e){var i=e.channel_id;var n=TS.utility.msgs.processImsg(e,i);n.channel_id=i;n.cached_request_id=e.cached_request_id;var s={};s.show_recap=true;s.score=e.score;s.feedback_options=e.feedback_options;s.request_id=e.request_id;s.cached_request_id=e.cached_request_id;s.justification=e.justification;t[i]=t[i]||{};t[i][e.ts]=s;return n});TS.client.highlights.addHighlights(t)}return i};var c=function e(){$("#unread_msgs_div").before(TS.templates.sli_briefing({show_onboarding:a.briefing_opens_count<l}));$("#unread_msgs_scroller_div").prepend(TS.templates.sli_briefing_header())};var f=function t(n){var l=_.get(n,"data.messages[0].cached_request_id");var d=!_.isUndefined(l)&&(l===TS.highlights_briefing.last_request_id||l===TS.highlights_briefing.last_cached_request_id);TS.highlights_briefing.last_cached_request_id=l;TS.highlights_briefing.last_request_id=n.request_id;a.loading=false;if(null!==a.last_open_ts&&a.last_open_ts<Date.now()-6e5||!d)a.expanded=false;if(_.get(n,"data.messages.length")){var o=_.groupBy(n.data.messages,"channel_id");var g=_(o).map(function(e,i){var t=TS.shared.getModelObById(i);var n=TS.shared.getTypeForModelOb(t);var s=TS.templates.builders.buildStarWithTip(n,t);var a={channel:t,star:new Handlebars.SafeString(s),messages:_(e).map(u).compact().value()};if(!a.messages.length)return null;return a}).compact().value();if(g.length){v(n.data.messages);i.find(".sli_briefing_view__messages").html(TS.templates.sli_briefing_message_view({groups:g}))}}else s={};if(n.data.headline){r={header:TS.format.formatWithOptions(n.data.headline.header||"","",{no_linking:true}),subheader:TS.format.formatWithOptions(n.data.headline.subheader||"","",{no_linking:true})};p(n.data.headline.users)}else r={header:"",subheader:""};var c=T();if(!c)e.hide();else if(a.expanded&&c)F(false);else{var f=C();m(f,T())}var h=_.get(a,["last_jump","model_ob_id"]);var b=_.get(a,["last_jump","ts"]);if(_.get(s,[h,b])){a.scroll_top=0;a.last_jump.ts=null;a.last_jump.model_ob_id=null}if(c){a.briefing_opens_count+=1;TS.storage.storeBriefingOpensCount(a.briefing_opens_count)}TS.highlights_briefing.updated_sig.dispatch()};var h=function e(i){var t=TS.shared.getModelObById(i.channel_id);var n=$(TS.templates.builders.msgs.buildHTML({msg:i,model_ob:t,enable_slack_action_links:true,container_id:"sli_briefing",prev_msg:null,briefing:true}));if(i.pinned_to&&i.pinned_to.length||_.get(i,"file.pinned_to.length"))n.removeClass("is_pinned");n.addClass("is_sli_briefing");return n[0].outerHTML};var u=function e(i){var t=TS.client.highlights.getHighlight(i.channel_id,i.ts);if(t.feedback&&"positive"!==t.feedback)return null;var n=y(t.feedback);var s=_.map(t.feedback_options.negative,function(e){return _.assign({},e,{text:new Handlebars.SafeString(TS.format.formatWithOptions(e.text,null,{no_linking:true}))})});return{message_markup:h(i),message:i,justification:t.justification,feedback_class:n,negative_feedback_options:s}};var m=function e(i,n,s,r){if(i&&n){t.removeClass("sli_briefing_preview--loading").addClass("sli_briefing_preview--has_briefings");t.find('[data-js="sli_briefing_preview_title"]').html(i.header);if(a.briefing_opens_count>=l)t.find('[data-js="sli_briefing_preview_description"]').html(i.subheader);t.find('[data-js="sli_briefing_preview_action"]').removeClass("hidden");if(a.briefing_opens_count>=l)t.find('[data-js="sli_briefing_preview_facepile"]').removeClass("hidden")}else if(s){t.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");t.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("¡Todo listo!","highlights")());t.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("¡Estos son todos los destacados! A continuación encontrarás el resto de tus mensajes sin leer.","highlights")());t.find('[data-js="sli_briefing_preview_action"]').addClass("hidden");t.find('[data-js="sli_briefing_preview_facepile"]').addClass("hidden")}else if(!r){t.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");t.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("No hay nuevos destacados","highlights")());t.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("Pero mantendremos los ojos abiertos.","highlights")());t.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}else{t.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");t.find('[data-js="sli_briefing_preview_title"]').removeClass("small_bottom_margin").addClass("error no_bottom_margin").text(TS.i18n.t("Imposible cargar destacados","highlights")());t.find('[data-js="sli_briefing_preview_description"]').addClass("hidden");t.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}TS.highlights_briefing.updated_sig.dispatch()};var p=function e(i){var n=_.map(i,function(e){var i=TS.members.getMemberById(e);return TS.templates.builders.makeMemberPreviewLinkImage(i,32,false,false,false,false)}).join("");t.find('[data-js="sli_briefing_preview_facepile"]').html(n)};var v=function e(i){s={};_.forEach(i,function(e){s[e.channel_id]=s[e.channel_id]||{};s[e.channel_id][e.ts]=e})};var b=function s(){if(!TS.model.team.plan)return;P();e=null;i=null;t=null;n=null;TS.highlights_briefing.$briefing_header=null;TS.highlights_briefing.$briefing_view=null;TS.highlights_briefing.last_request_id=null;r=null;a.last_open_ts=Date.now()};var T=function e(){return _.reduce(s,function(e,i,t){return e+S(t)},0)};var S=function e(i){return _.reduce(s[i],function(e,i){if(!w(i))return e;return e+1},0)};var k=function e(){return _(s).flatMap(function(e){return _.map(e,function(e){if(!w(e))return null;return e})}).compact().value()};var w=function e(i){var t=TS.client.highlights.getHighlight(i.channel_id,i.ts)||{};return!(i._removed||"dismiss"===t.feedback||t.left_feedback)};var C=function e(){return r};var y=function e(i){if("negative"===i)return"gave_negative_feedback";if("positive"===i)return"gave_positive_feedback";if("dismiss"===i)return"sli_briefing__feedback--dismiss";return""};var j=function e(){if(TS.model.active_cid===_.get(a,["last_jump","model_ob_id"])&&a.show_briefing_back_button)q();else if(a.last_jump&&a.show_briefing_back_button)I()};var x=function e(){if(!TS.model.team.plan)return;if(a.last_jump&&a.show_briefing_back_button)I()};var q=function e(){$(".sli_briefing__channel_back_button").removeClass("hidden");$("#messages_unread_status").addClass("sli_briefing--has_back_button")};var I=function e(){$(".sli_briefing__channel_back_button").addClass("hidden");$("#messages_unread_status").removeClass("sli_briefing--has_back_button");a.show_briefing_back_button=false};var H=function r(){e=$("#sli_briefing");i=$("[data-js=sli_briefing_view]");t=$('[data-js="sli_briefing_preview_container"]');n=$('[data-js="sli_briefing_header"]');TS.highlights_briefing.$briefing_header=n;TS.highlights_briefing.$briefing_view=i;e.on("click",".sli_briefing__message ts-message, .sli_briefing_target",function(e){if(!$(e.target).is("ts-message, .message_content, .message_body, .message_content_header_left, .sli_briefing_target, .comment, .rxn_panel")&&!$(e.target).parents(".message_body").length||$(e.target).parents(".msg_inline_file_preview_toggler").length||$(e.target).is("a")&&$(e.target).closest(".message_body").length||$(e.target).closest(".attachment_media").length)return;var i=$(this).is("ts-message")?$(this):$(this).parents("ts-message");var t=""+i.data("ts");var n=""+i.data("model-ob-id");A(n,t)});e.on("click",".sli_briefing__channel_link .channel_link",function(e){var i=$(e.target).closest("[data-channel-id]").data("channel-id");if("G"===i[0])TS.groups.displayGroup({id:i})});e.on("click",'[data-js="sli_briefing_preview"]',function(){if(a.loading)return;a.expanded=true;F(true);var e={request_id:TS.highlights_briefing.last_request_id};var i=_.keys(s)[0];var t=_.keys(_.get(s,[i]))[0];var n=TS.client.highlights.getHighlight(i,t);var r=n.cached_request_id;if(r)e.cached_request_id=r;TS.clog.track("BRIEFING_REVEAL",e);TS.highlights_briefing.updated_sig.dispatch()});n.off("click").on("click",'[data-js="sli_briefing_header_dismiss_all"]',function(){a.expanded=false;M();var e=k();var i=_.map(e,function(e){return{channel_id:e.channel_id,ts:e.ts}});TS.api.call("highlights.dismissAll",{request_id:TS.highlights_briefing.last_request_id,source:"briefing",messages:JSON.stringify(i)}).catch(function(e){TS.error(e)})});e.on("click",'[data-js="sli_briefing_feedback_item"] a',function(e){e.preventDefault();var i=($(e.target).closest(".sli_briefing__feedback_leavebehind").data("feedback-for-cache-id")||"").split("-");var t=Number($(e.target).closest("li").data("index"));var n=i[0];var s=i[1];TS.client.highlights.setNegativeFeedbackForHighlight(n,s,t,"briefing")});e.on("click","[data-feedback]",function(e){e.preventDefault();var i=$(e.target).data("feedback");var t=$(e.target).closest(".sli_briefing__message");var n=(t.data("cache-id")||"").split("-");var s=n[0];var a=n[1];TS.client.highlights.setDefaultFeedbackForHighlight(s,a,{feedback:i},"briefing");$("#ts_tip_float_floater .ts_tip_tip").text(TS.i18n.t("¡Gracias!","highlights")())})};var B=function e(i){if(!TS.model.unread_view_is_showing)return;_.each(i,function(e,i){_.each(e,function(e,t){if(s[i]&&s[i][t]){var n=$('[data-cache-id="'+i+"-"+t+'"]');if(n.length)E(n,i,t,e)}})})};var E=function e(i,t,n,s){if("dismiss"===s.feedback||!s.is_leaving_feedback&&s.left_feedback)O(i,t,function(){if(G())D()});else if("negative"===s.feedback&&s.is_leaving_feedback){i.find("ts-message").addClass("hidden");i.addClass("gave_negative_feedback");i.find('[data-feedback="negative"]').addClass("sli_briefing__feedback_control--pulse");$('[data-feedback-for-cache-id="'+t+"-"+n+'"]').removeClass("hidden")}else if("positive"===s.feedback){i.addClass("gave_positive_feedback");i.find('[data-feedback="positive"]').addClass("sli_briefing__feedback_control--pulse")}};var F=function t(s){var a=e.outerHeight();var r=$('[data-js="sli_briefing_preview_container"]');var _=61;i.removeClass("hidden");n.removeClass("hidden");TS.client.ui.checkInlineImgsAndIframes("unread");if(s){r.css({height:0,"margin-top":(TS.environment.supports_sticky_position?-_:0)+"px"});var l=e.outerHeight();e.css({height:a,"padding-top":_+20+"px","margin-top":-_+"px"});e.animate({height:l+_},300,function(){e.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?_+20+"px":""});i.find(".sli_briefing__channel, .sli_briefing_view__footer").each(function(e,i){setTimeout(function(){$(i).css("opacity",1)},100*e+200)});if(!TS.prefs.getPref("seen_highlights_warm_welcome")){setTimeout(function(){TS.coachmark.start(TS.coachmarks.coachmarks.highlights_feedback,true)},800);TS.prefs.setPref("seen_highlights_warm_welcome",true);TS.prefs.setPrefByAPI({name:"seen_highlights_warm_welcome",value:true});TS.clog.track("PREF_USER_CLIENT_UPDATE",{updated_user_client_prefs:{seen_highlights_warm_welcome:"true"}})}TS.highlights_briefing.updated_sig.dispatch()})}else{r.css({transition:"none",height:0,"margin-top":(TS.environment.supports_sticky_position?-_:0)+"px"});n.css("transition","none");i.find(".sli_briefing__channel, .sli_briefing_view__footer").css("opacity",1);e.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?_+20+"px":""})}r.addClass("go-away");n.addClass("expand");if(!s)setTimeout(function(){n.css("transition","");r.css("transition","")},0)};var M=function t(){var s=$('[data-js="sli_briefing_preview_container"]');n.removeClass("expand").addClass("go-away");var a=e.outerHeight();i.css({opacity:0,"pointer-events":"none"});m(null,0,true);var r=166;e.css({height:a,"margin-top":TS.environment.supports_sticky_position?"-61px":""});e.animate({height:r},300,function(){TS.highlights_briefing.updated_sig.dispatch()});s.css({transition:"none",transform:"translateY(118px)"});setTimeout(function(){s.css({transition:"",transform:"translateY(0)",opacity:1,"pointer-events":""})},0)};var P=function i(){if(e)e.off("click");if(n)n.off("click")};var A=function e(i,t){var n;var s;var r=TS.client.highlights.getHighlight(i,t);n=r.request_id;s=r.cached_request_id;a.scroll_top=TS.client.ui.unread.$scroller.scrollTop();a.last_jump={ts:t,model_ob_id:i};a.show_briefing_back_button=true;TS.client.ui.tryToJump(i,t);var _={channel_id:i,channel_type:i[0]||"",message_timestamp:t,request_id:n};if(s)_.cached_request_id=s;TS.clog.track("BRIEFING_JUMP_TO_CHANNEL",_)};var O=function e(i,t,n){var s=0===S(t);if(s)N(i.closest(".sli_briefing__channel"),n);else{i.addClass(y("dismiss"));setTimeout(function(){i.css({transition:"margin-bottom 0.3s","margin-bottom":0});i.animate({height:0},300,function(){var e=i.parents('.sli_briefing__channel[data-channel-id="'+t+'"]');i.remove();if(R(t)){e.css({transition:"opacity 0.2s",opacity:.5});e.find(".sli_briefing__channel_link .star").css("pointer-events","none")}if(n)n()})},300)}};var N=function e(i,t){i.addClass("dismiss");setTimeout(function(){i.css({transition:"margin-bottom 0.3s","margin-bottom":0});i.animate({height:0},300,function(){i.remove();if(t)t()});if(!T())$(".sli_briefing_view__footer").css("opacity",0)},300)};var R=function e(i){return _.every(s[i],function(e,t){var n=TS.client.highlights.getHighlight(i,t);return!n||"dismiss"===n.feedback})};var G=function e(){return _.every(s,function(e,i){return _.every(s[i],function(e,t){var n=TS.client.highlights.getHighlight(i,t);if(!n)return true;return"dismiss"===n.feedback||true===n.left_feedback})})};var D=function i(){e.replaceWith(TS.templates.sli_briefing());n.addClass("hidden");H();m(null,0,true);a.expanded=false};var W=function e(i){if(!TS.model.team.plan)return;if(!TS.model.unread_view_is_showing)return;if(!i||!s||_.isEmpty(s)||!s[i.id])return;_.each(s[i.id],function(e,t){if(t<i.last_read&&!e._removed)TS.client.highlights.setDefaultFeedbackForHighlight(i.id,t,{feedback:"dismiss"},"briefing-mark-as-read")})};var L=function e(i){if(!TS.model.team.plan)return;if(!TS.model.unread_view_is_showing)return;if(!i||!s||_.isEmpty(s)||!s[i.id])return;_.each(s[i.id],function(e,t){var n=$('.sli_briefing__message[data-cache-id="'+i.id+"-"+t+'"]');if(n.length){var s=n.find("ts-message");if(s.hasClass("is_pinned"))s.removeClass("is_pinned")}})};var U=function e(i,t,n){if(!TS.model.unread_view_is_showing)return;if(!TS.model.team.plan)return;if(!s||_.isEmpty(s)||!s[i.id]||!s[i.id][t.ts]||!(_.includes(n,"text")||_.includes(n,"reply_count")))return;var a=_.assign({},t,{channel_id:i.id});s[i.id][t.ts]=a;var r=$('.sli_briefing__message[data-cache-id="'+i.id+"-"+t.ts+'"]');if(!r.length)return;var l=r.find("ts-message");l.replaceWith(h(a))};var J=function e(i,t){if(!TS.model.unread_view_is_showing)return;if(!TS.model.team.plan)return;if(!s||_.isEmpty(s)||!s[i.id]||!s[i.id][t.ts])return;TS.client.highlights.setDefaultFeedbackForHighlight(i.id,t.ts,{feedback:"dismiss"})}})()}},[1486]);