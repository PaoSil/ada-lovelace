webpackJsonp([313],{1483:function(e,r){(function(){TS.registerModule("files.gdrive",{onStart:function e(){if(!TS.client)return;TS.files.team_file_shared_sig.add(S)},openPickerWindow:function r(){var n=null;return new Promise(function(r,a){var o=TS.utility.window.open({url:e,try_window_open_in_ssb:true,height:t});if(!o)a(new Error("could not open window"));n=l(r,a);window.addEventListener("message",n);if(i)a("Promise already made");i=true}).then(function(e){i=false;return d(e.chosen_files,TS.shared.getActiveModelOb())}).catch(function(e){if("Promise already made"===e)return;var r=a;var n=TS.shared.getActiveModelOb();TS.error(e);if(("unidentified_external_url"===e.data.error||"file_type_has_no_handler"===e.data.error)&&e.args.link){r=TS.i18n.t("De momento no es posible importar ese tipo de archivo de Google Drive, pero hemos incluido un enlace para que los demás puedan acceder a él.","files")();v(n.id,e.args.link)}if("filename_too_long"===e.data.error)r=o;TS.client.ui.addEphemeralBotMsg({text:r,ephemeral_type:"file_type_has_no_handler",slackbot_feels:"sad_surprise"});i=false}).finally(function(){window.removeEventListener("message",n)})},createAndShare:function e(r,n){return m(r,n).then(function(e){TS.files.gdrive.create(r,e)}).catch(function(){TS.menu.file.onGDriveCreateComplete(false)})},create:function e(r,t){if(t&&t.channel){var i=TS.shared.getModelObById(t.channel);if(i.is_channel)TS.channels.displayChannel({id:i.id});else if(i.is_mpim)TS.mpims.displayMpim({id:i.id});else if(i.is_group)TS.groups.displayGroup({id:i.id});else if(TS.ims.getImByMemberId(t.channel))TS.ims.startImByMemberId(t.channel);else TS.error("no valid shared channel/im/mpim/group to display")}return TS.api.call("files.createExternal",{service_stub:"gdrive",mime_type:n+"."+r,filename:t.title||"",open_edit:!!t.channel}).then(function(e){TS.utility.window.alwaysOpenInBrowser(e.data.url);if(t&&t.channel)p(e.data.url,t.channel,t.comment);TS.menu.file.onGDriveCreateComplete(true,e)}).catch(function(e){TS.menu.file.onGDriveCreateComplete(false);var n=a;if("use_auth_url"===e.data.error)return f(r,t);if("filename_too_long"===e.data.error)n=o;TS.error(e);TS.client.ui.addEphemeralBotMsg({text:n,ephemeral_type:"unhandled_gdrive_create",slackbot_feels:"sad_surprise"})})}});var e=TS.boot_data.team_url+"files/import/gdrive";var r=TS.boot_data.team_url+"files/create/gdrive/auth";var n="application/vnd.google-apps";var t=675;var i=false;var a=TS.i18n.t("Jolín, no ha funcionado. Vuelve a intentarlo o <https://my.slack.com/help/requests/new|contactános>  si sigue sin funcionar.","files")();var o=TS.i18n.t("¡Lo sentimos! El nombre del archivo es demasiado grande y no podemos procesarlo. Prueba importando un archivo con un nombre más corto, por favor.","files")();var l=function e(r,n){return c({resolve:r,reject:n,method:"gdrive_picker"})};var s=function e(r,n){return c({resolve:r,reject:n,method:"google_auth"})};var c=function e(r){return function(e){if(e.data.method!==r.method)return;if(!e.data.ok)r.reject(new Error(r.method+" not ok"));else r.resolve(e.data)}};var d=function e(r,n){var t=r.map(function(e){return u(e,n)});return Promise.all(t)};var u=function e(r,n){return TS.api.call("files.uploadExternal",{channels:n.id,link:r.url}).then(function(e){if(n.user&&TS.ims.getImByMemberId(n.user)&&TS.model.team.enterprise_id)v(n.id,e.data.file.url_private,true,true)})};var f=function e(n,i){var a=null;return new Promise(function(e,n){var i=TS.utility.window.open({url:r,try_window_open_in_ssb:true,height:t});if(!i)n(new Error("could not open window"));a=s(e,n);window.addEventListener("message",a)}).then(function(){return TS.files.gdrive.create(n,i)}).catch(function(e){TS.error(e)}).finally(function(){window.removeEventListener("message",a)})};var m=function e(r,t){return new Promise(function(e,i){var a={type:n+r,display_type:t};var o=TS.templates.builders.buildFileSharingControls(a,false,false,true,null);var l=void 0;if("Document"===t)l=TS.i18n.t("Crear un documento de Google","files")();else if("Presentation"===t)l=TS.i18n.t("Crear una presentación de Google","files")();else if("Spreadsheet"===t)l=TS.i18n.t("Crear una hoja de cálculo de Google","files")();else l=TS.i18n.t("Crear un archivo de Google","files")();TS.generic_dialog.start({title:l,body:TS.templates.gdrive_create_dialog({sharing_html:new Handlebars.SafeString(o)}),show_cancel_button:true,esc_for_ok:false,fullscreen:false,go_button_text:TS.i18n.t("Crear","files")(),type:"overflow_visible",onGo:function r(){e(h())},onCancel:i});$("#share_cb").removeAttr("checked");TS.ui.file_share.bindFileShareDropdowns();TS.ui.file_share.bindFileShareShareToggle();TS.ui.file_share.bindFileShareCommentField();TS.ui.comments.bindInput($("#file_comment_textarea"),function(){e(h)})})};var h=function e(){var r=_.trim(TS.utility.contenteditable.value($("#file_comment_textarea")));r=TS.utility.contenteditable.synchronouslyReplacePotentialMentions(r,{complete_member_specials:false});return{title:_.trim($("#document_title").val())||TS.i18n.t("Sin título","files")(),comment:r,channel:$("#share_cb").is(":checked")?$("#share_model_ob_id").val():false}};var p=function e(r,n,t){var i=false;if(TS.ims.getImByMemberId(n))i=true;return TS.api.call("files.uploadExternal",{link:r,channels:i?"":n}).then(function(e){if(i)v(n,e.data.file.url_private,true,true);if(t)TS.api.call("files.comments.add",{file:e.data.file.id,comment:t,channel:n})}).catch(function(e){TS.error(e);TS.client.ui.addEphemeralBotMsg({text:TS.i18n.t("¡Oh, no! No he podido importar el archivo que acabas de crear","files")(),ephemeral_type:"gdrive_share_file_error",slackbot_feels:"sad_surprise"})})};var v=function e(r,n,t,i){TS.api.call("chat.postMessage",{channel:r,text:n,unfurl_links:t||false,unfurl_media:i||false}).catch(function(e){TS.error(e)})};var S=function e(r){if("gdrive"!==_.get(r,"external_type"))return;if(_.get(r,"user")!==TS.model.user.id)return;if(!TS.prefs.getTeamPref("gdrive_enabled_team"))return;if(TS.prefs.getPref("seen_gdrive_coachmark"))return;TS.coachmark.start(TS.coachmarks.coachmarks.gdrive);TS.prefs.setPref("seen_gdrive_coachmark",true);TS.prefs.setPrefByAPI({name:"seen_gdrive_coachmark",value:true})}})()}},[1483]);